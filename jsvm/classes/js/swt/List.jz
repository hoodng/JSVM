$package("js.swt");$import("js.swt.ListItem");js.swt.List = function (def, runtime) {var CLASS = js.swt.List, thi$ = CLASS.prototype;if (CLASS.__defined__) {this._init.apply(this, arguments);return;}CLASS.__defined__ = true;var Class = js.lang.Class, Event = js.util.Event, DOM = J$VM.DOM, System = J$VM.System, LinkedList = js.util.LinkedList, ListItem = js.swt.ListItem;thi$.item = function (uuid) {return this._local.cache[uuid];};thi$.isReady = function () {return this._isReady;};var _preSelect = function (item) {if (!item.isSelected()) {return;}var uuid = item.uuid();if (this.multiEnable || (this._selectedItems.length == 0)) {this._selectedItems.addLast(uuid);} else {item.setSelected(false);}};thi$.addItem = function (item, ack) {if (!item || !(item instanceof ListItem) || (this.distinct && this.contains(item.def))) {return;}item.setPeerComponent(this);DOM.appendTo(item.view, this.listView);var uuid = item.uuid();this._items.addLast(uuid);this._local.cache[uuid] = item;_preSelect.call(this, item);this._canBeSearched = this._canBeSearched && (item.isSearchable());if (ack === true) {_sendAck.call(this, "ACK_ADD", true);}};var _setItems = function (items, append) {var len = items ? items.length : 0;if (!append) {this._isReady = false;this.wipe();if (len == 0) {_sendAck.call(this, "ACK_ADD", true);}}if (len == 0) {return;}var i, item;for (i = 0; i < len; i++) {item = items[i];if (this.lazy) {this.addItem.$delay(this, 0, item, (i == len - 1));} else {this.addItem(item, (i == len - 1));}}};thi$.setItems = function (items) {_setItems.call(this, items, false);};thi$.addItems = function (items) {_setItems.call(this, items, true);};var _createItemDef = function (model) {var itemDef = {markable:this.multiByCheck, showTips:this.showTips, toggle:false, model:model};return itemDef;};thi$.addItemByDef = function (itemDef, ack) {if (!itemDef || (this.distinct && this.contains(itemDef))) {return;}var itemClassName = this.def.itemClassName;if (!itemDef.className && itemClassName) {itemDef.className = itemClassName;}itemDef.css = "position:relative;width:100%;overflow:visible;" + "white-space:nowrap;";if (this.multiEnable && this.multiByCheck) {itemDef.markable = true;} else {itemDef.markable = false;}var item = new ListItem(itemDef, this.Runtime()), uuid = item.uuid();item.setPeerComponent(this);DOM.appendTo(item.view, this.listView);this._items.addLast(uuid);this._local.cache[uuid] = item;_preSelect.call(this, item);this._canBeSearched = this._canBeSearched && (item.isSearchable());if (ack === true) {_sendAck.call(this, "ACK_ADD", true);}};thi$.addItemByModel = function (model, ack) {if (!model) {return;}var def = _createItemDef.call(this, model);this.addItemByDef(def, ack);};var _setItemsByModel = function (models, append) {var len = models ? models.length : 0;if (!append) {this._isReady = false;this.wipe();if (len == 0) {_sendAck.call(this, "ACK_ADD", true);}}if (len == 0) {return;}var i, model, def;for (i = 0; i < len; i++) {model = models[i];if (!model) {throw "Unsupport item's model " + String(model);}def = _createItemDef.call(this, model);if (this.lazy) {this.addItemByDef.$delay(this, 0, def, (i == len - 1));} else {this.addItemByDef(def, (i == len - 1));}}};thi$.setItemsByModel = function (models) {_setItemsByModel.call(this, models, false, false);};thi$.addItemsByModel = function (models) {_setItemsByModel.call(this, models, true, false);};var _setItemsByDef = function (defs, append) {var len = defs ? defs.length : 0;if (!append) {this._isReady = false;this.wipe();if (len == 0) {_sendAck.call(this, "ACK_ADD", true);}}if (len == 0) {return;}var def;for (var i = 0; i < len; i++) {def = defs[i];if (!def) {throw "Unsupport item's difinition " + String(def);}if (this.lazy) {this.addItemByDef.$delay(this, 0, def, (i == len - 1));} else {this.addItemByDef(def, (i == len - 1));}}};thi$.setItemsByDef = function (defs) {_setItemsByDef.call(this, defs, false, false);};thi$.addItemsByDef = function (defs) {_setItemsByDef.call(this, defs, true, false);};thi$.remove = function (item, ack) {if (item && (typeof item == "object")) {var uuid = item.uuid();this._selectedItems.remove(uuid);this._items.remove(uuid);delete this._local.cache[uuid];item.removeFrom(this.listView);if (typeof this.onItemRemoved == "function") {this.onItemRemoved(item);}item.destroy();item = null;if (ack === true) {_sendAck.call(this, "ACK_REMOVE", true);}}};thi$.removeItems = function (items) {var len = items ? items.length : 0;if (len <= 0) {return;}(function (len, item, idx) {if (this.lazy) {this.remove.$delay(this, 0, item, (idx == len - 1));} else {this.remove(item, (idx == len - 1));}}).$forEach(this, items, len);};thi$.removeAll = function () {this.wipe();_sendAck.call(this, "ACK_REMOVE", true);};var _setAck = function (signal) {switch (signal) {case "ACK_ADD":var ready = this._isReady;this._isReady = true;this.fireEvent(new Event(CLASS.EVT_ACK_ITEMSADDED, undefined, this));if (!ready) {this.fireEvent(new Event(CLASS.EVT_READY, undefined, this));}_layout.call(this);break;case "ACK_REMOVE":this.fireEvent(new Event(CLASS.EVT_ACK_ITEMSREMOVED, undefined, this));_layout.call(this);break;default:break;}};var _sendAck = function (signal, invalid) {if (invalid === true) {_invalidateSize.call(this);}_setAck.call(this, signal);};thi$.getItemsByModel = function (items, model) {if (!model || (typeof model !== "object")) {return null;}var finds = [], len = items.length, item;for (var i = 0; i < len; i++) {item = items[i];if (item.isMine(model)) {finds.push(item);}}return finds;};thi$.getItemsByDname = function (items, dname) {if (typeof dname !== "string") {return null;}var finds = [], len = items.length, item, v;for (var i = 0; i < len; i++) {item = items[i];v = item && item.model ? item.model.dname : null;if (v && dname === v) {finds.push(item);}}return finds;};thi$.getItemsByValue = function (items, value) {if (value == undefined || value == null) {return null;}var finds = [], len = items.length, item, v;for (var i = 0; i < len; i++) {item = items[i];v = item ? item.getValue() : null;if (value === v) {finds.push(item);if (this.distinct) {return finds;}}}return finds;};thi$.contains = function (itemDef) {var m = itemDef ? itemDef.model : undefined;if (!m || (typeof m !== "object")) {return false;}var len = this._items ? this._items.length : 0, item;for (var i = 0; i < len; i++) {item = this.item(this._items[i]);if (item.isMine(m)) {return true;}}return false;};var _getInfoByUUids = function (ids, prop, distinct) {var len = ids ? ids.length : 0, rst = LinkedList.$decorate([]), item, m, v;for (var i = 0; i < len; i++) {item = this.item(ids[i]);switch (prop) {case "def":rst.addLast(item.def);break;case "model":m = item ? item.model : undefined;if (m && (distinct !== true || !CLASS.isModelIn(m, rst))) {rst.addLast(m);}break;case "value":m = item ? item.model : undefined;v = m ? m.value : undefined;if (v && (distinct !== true || !rst.contains(v))) {rst.addLast(v);}break;default:rst.addLast(item);break;}}return rst;};var _getInfoByUUids0 = function (ids, prop, distinct) {if (!Class.isArray(ids) || ids.length == 0) {return [];}LinkedList.$decorate(ids);var len = this._items ? this._items.length : 0, rst = LinkedList.$decorate([]), uuid, item, m, idx;for (var i = 0; i < len; i++) {uuid = this._items[i];if (!ids.contains(uuid)) {continue;}item = this.item(uuid);switch (prop) {case "def":rst.addLast(item.def);break;case "model":m = item ? item.model : undefined;if (m && (distinct !== true || !CLASS.isModelIn(m, rst))) {rst.addLast(m);}break;case "value":m = item ? item.model : undefined;v = m ? m.value : undefined;if (v && (distinct !== true || !rst.contains(v))) {rst.addLast(v);}break;case "index":idx = i;if (distinct !== true || !rst.contains(idx)) {rst.addLast(idx);}break;default:rst.addLast(item);break;}}return rst;};thi$.getAll = function () {var len = this._items ? this._items.length : 0, rst = [];for (var i = 0; i < len; i++) {rst.push(this.item(this._items[i]));}return rst;};thi$.getItems = function () {return this.getAll();};thi$.getItemDefs = function () {return _getInfoByUUids.call(this, this._items, "def");};thi$.getItemModels = function () {return _getInfoByUUids.call(this, this._items, "model");};thi$.getSelectedItems = function (isOrdered) {var rst;if (isOrdered === true) {rst = _getInfoByUUids0.call(this, this._selectedItems);} else {rst = _getInfoByUUids.call(this, this._selectedItems);}return rst;};thi$.getSelectedDefs = function (isOrdered) {var rst;if (isOrdered === true) {rst = _getInfoByUUids0.call(this, this._selectedItems, "def");} else {rst = _getInfoByUUids.call(this, this._selectedItems, "def");}return rst;};thi$.getSelectedModels = function (isOrdered) {var rst;if (isOrdered === true) {rst = _getInfoByUUids0.call(this, this._selectedItems, "model", true);} else {rst = _getInfoByUUids.call(this, this._selectedItems, "model", true);}return rst;};thi$.getSelectedIndexes = function () {return _getInfoByUUids0.call(this, this._selectedItems, "index", true);};thi$.getSelectedValues = function (isOrdered) {var rst;if (isOrdered === true) {rst = _getInfoByUUids0.call(this, this._selectedItems, "value", true);} else {rst = _getInfoByUUids.call(this, this._selectedItems, "value", true);}return rst;};thi$.wipe = function () {if (!this.listView) {return;}this._local.cache = {};this._selectedItems = LinkedList.$decorate([]);this._items = LinkedList.$decorate([]);this.listView.innerHTML = "";delete this._contentSize;if (!this.isPreferredSizeSet) {this.def.prefSize = undefined;}};var _measure = function () {var cv = this.listView, w, h;cv.style.overflow = "hidden";cv.style.width = "0px";cv.style.height = "0px";DOM.appendTo(cv, document.body);w = cv.scrollWidth;h = cv.scrollHeight;cv.style.overflow = "visible";cv.style.width = w + "px";cv.style.height = h + "px";DOM.appendTo(cv, this.view);this._contentSize = this._contentSize || {};this._contentSize.width = w;this._contentSize.height = h;System.log.println("List Size:" + JSON.stringify(this._contentSize));};var _measure$ = function () {var cv = this.listView, w, h;cv.style.overflow = "hidden";cv.style.width = "0px";cv.style.height = "0px";w = cv.scrollWidth;h = cv.scrollHeight;cv.style.overflow = "visible";cv.style.width = w + "px";cv.style.height = h + "px";this._contentSize = this._contentSize || {};this._contentSize.width = w;this._contentSize.height = h;};var _invalidateSize = function (items) {this._isLayoutDirty = true;_measure.call(this);if (this.isDOMElement() && !this.isPreferredSizeSet) {this.def.prefSize = undefined;this.getPreferredSize();}};var _calPreferredSize = function () {if (!this._contentSize) {_measure.call(this);}var s = this._contentSize, cw = s ? s.width : undefined, ch = s ? s.height : undefined, d = this.getBounds(), mbp = d.MBP, w = d.width, h = d.height;w = !isNaN(cw) ? (cw + mbp.BPW) : w;h = !isNaN(ch) ? (ch + mbp.BPH) : h;return {width:w + 2, height:h + 2};};thi$.getContentSize = function () {if (!this._contentSize) {_measure.call(this);}return this._contentSize;};thi$.getPreferredSize = function () {if (this.def.prefSize == undefined) {var s = _calPreferredSize.call(this);this.setPreferredSize(s.width, s.height);}return this.def.prefSize;}.$override(this.getPreferredSize);var _layoutListView = function (w, h, box) {box = box || this.getBounds();var mbp = box.MBP, avaiW = w - mbp.BPW, avaiH = h - mbp.BPH;var cvSize = this._contentSize, cw, ch;cw = (cvSize.width < avaiW) ? "100%" : (cvSize.width + "px");ch = (cvSize.height < avaiH) ? "100%" : (cvSize.height + "px");this.listView.style.width = cw;this.listView.style.height = ch;};var _layout = function (w, h) {if (!this._isLayoutDirty || !this._isReady || !this.isDOMElement()) {return;}this._isLayoutDirty = false;var d = this.getBounds(), prefSize = this.getPreferredSize(), maxSize = this.isMaximumSizeSet ? this.getMaximumSize() : null, minSize = this.isMinimumSizeSet ? this.getMinimumSize() : null;w = (!isNaN(w) && w > 0) ? w : (this.hauto ? prefSize.width : d.width);h = (!isNaN(h) && h > 0) ? h : (this.vauto ? prefSize.height : d.height);if (minSize) {w = (!isNaN(minSize.width) && minSize.width > 0) ? Math.max(w, minSize.width) : w;h = (!isNaN(minSize.height) && minSize.height > 0) ? Math.max(h, minSize.height) : h;}if (maxSize) {w = !isNaN(maxSize.width) ? Math.min(w, maxSize.width) : w;h = !isNaN(maxSize.height) ? Math.min(h, maxSize.height) : h;}_layoutListView.call(this, w, h, d);this.setSize(w, h);};thi$.onResized = function () {this._isLayoutDirty = true;arguments.callee.__super__.apply(this, arguments);}.$override(this.onResized);thi$.onGeomChanged = function () {this._isLayoutDirty = true;arguments.callee.__super__.apply(this, arguments);}.$override(this.onGeomChanged);thi$.doLayout = function () {if (arguments.callee.__super__.apply(this, arguments)) {_layout.call(this);return true;}return false;}.$override(this.doLayout);thi$.dispose = function (w, h) {this._isLayoutDirty = true;_layout.apply(this, arguments);};thi$.canBeSearched = function () {return this._canBeSearched;};thi$.setSearchEnable = function (b) {var v = (b === true);if (this.searchEnable === v) {return;}this.searchEnable = v;if (this.searchEnable) {this.searcher = this.searcher || new (Class.forName("js.swt.Searcher"))(this, this.def.searchOptions);} else {if (this.searcher) {this.searcher.destroy();}this.searcher = null;}};thi$.quickSearch = function (keyword, options) {if (this.searcher && (typeof keyword === "string")) {this.searcher.search(keyword, options);}};thi$.restore = function () {if (this.searcher) {this.searcher.restore();}};var _selectItems = function (items) {var len = items ? items.length : 0;if (len == 0) {return;}var item;for (var i = 0; i < len; i++) {item = items[i];this.selectItem(item);}};thi$.selectItem = function (item) {var uuid = item ? item.uuid() : undefined;if (uuid && !this._selectedItems.contains(uuid)) {item.setSelected(true);this._selectedItems.addLast(uuid);}};var _onItemSelected = function (arg) {this.fireEvent(new Event(CLASS.EVT_ITEMSELECTED, arg, this));if (typeof this.onSelected === "function") {this.onSelected(arg);}};thi$.setSelectedValues = function (values, callback) {var len = values ? values.length : 0;if (len == 0) {return;}this.unselectAll();var cnt = this.multiEnable ? len : 1, value, items;for (var i = 0; i < cnt; i++) {value = values[i];items = this.getItemsByValue(this.getItems(), value);_selectItems.call(this, items);}if (callback) {_onItemSelected.call(this, arguments[2]);}};thi$.setSelectedIndexes = function (indexes, callback) {var len = indexes ? indexes.length : 0;if (len == 0) {return;}this.unselectAll();var cnt = this.multiEnable ? len : 1, item, items = [];for (var i = 0; i < cnt; i++) {item = this.item(this._items[indexes[i]]);items.push(item);}_selectItems.call(this, items);if (callback) {_onItemSelected.call(this, arguments[2]);}};thi$.setSelectedItems = function (items, callback) {if (!items || items.length == 0) {return;}this.unselectAll();var temp = this.multiEnable ? items : [items[0]];_selectItems.call(this, temp);if (callback) {_onItemSelected.call(this, arguments[2]);}};thi$.selectAll = function (callback) {var len = this._items.length, item;for (var i = 0; i < len; i++) {item = this.item(this._items[i]);if (!item.isSelected()) {this.selectItem(item);}}if (callback === true) {_onItemSelected.call(this);}};var _unselectItem = function (item) {if (item) {item.setSelected(false);this._selectedItems.remove(item.uuid());}};thi$.unselectItem = function (item) {if (item) {_unselectItem.call(this, item);}};thi$.unselectAll = function (callback) {var uuid, item;while (this._selectedItems.length > 0) {uuid = this._selectedItems.getLast();item = this.item(uuid);_unselectItem.call(this, item);}if (callback === true) {_onItemSelected.call(this, arguments[1]);}};thi$.invertSelection = function () {var len = this._items.length, item;for (var i = 0; i < len; i++) {item = this.item(this._items[i]);if (item.isSelected()) {this.unselectItem(item);} else {this.selectItem(item);}}};thi$.isAllSelected = function () {var itemCnt = this._items.length, selectedCnt = this._selectedItems.length;if (!this.multiEnable) {return false;} else {if (selectedCnt === itemCnt) {return true;} else {if (this.distinct && (selectedCnt !== itemCnt)) {return false;} else {var item;for (var i = 0; i < itemCnt; i++) {item = this.item(this._items[i]);if (!item.isSelected()) {return false;}}return true;}}}};thi$.onStateChange = function () {if (!this.container) {return;}if (this.isEnabled()) {this.showCover(false);} else {this.showCover(true);}};thi$.destroy = function () {delete this._selectedItems;delete this._items;delete this._local.cache;if (this.searcher) {this.searcher.destroy();delete this.searcher;}DOM.remove(this.listView, true);delete this.listView;arguments.callee.__super__.apply(this, arguments);}.$override(this.destroy);var _select = function (listItem, ctrlKey, shiftKey) {if (!listItem) {return;}if (this.multiEnable && ctrlKey) {if (listItem.isSelected()) {this.unselectItem(listItem);} else {this.selectItem(listItem);}} else {if (this.multiEnable && shiftKey) {if (this._selectedItems.length == 0) {this.selectItem(listItem);} else {var fUUID = this._selectedItems.getLast(), from = this._items.indexOf(fUUID), to = this._items.indexOf(listItem.uuid()), step = (to - from) / Math.abs(to - from), index, item;for (var i = 1, cnt = Math.abs(to - from); i <= cnt; i++) {index = from + step * i;item = this.item(this._items[index]);this.selectItem(item);}}} else {this.unselectAll();this.selectItem(listItem);}}};var _selectCheckableItem = function (item) {if (!item) {return;}if (this.multiEnable) {if (item.isSelected()) {this.unselectItem(item);} else {this.selectItem(item);}} else {this.unselectAll();this.selectItem(item);}};thi$.showController = function (b, item) {if (!this.controller) {return;}if (b) {this.controller.setAttribute("itemUUID", item.uuid());this.controller.display(true);var vb = this.getBounds(), ib = item.getBounds(), s = this.controller.getPreferredSize(), vOffset = (ib.height - s.height) * 0.5, x = this.view.scrollLeft + (vb.clientWidth - s.width), y = this.view.scrollTop + (ib.absY - vb.absY + vb.MBP.borderTopWidth) + vOffset;this.controller.setBounds(x, y, s.width, s.height, 7);} else {this.controller.removeAttribute("itemUUID");this.controller.display(false);}};var _onHover = function (e) {var from = e.fromElement, to = e.toElement, fid = from ? from.uuid : "", tid = to ? to.uuid : "", fitem = this._local.cache[fid], titem = this._local.cache[tid];if (fitem && fitem.isHover()) {if (to && this.controller && this.controller.contains(to, true)) {return;}fitem.setHover(false);this.showController(false);}if (titem && !titem.isHover()) {titem.setHover(true);if (titem.hasController()) {this.showController(true, titem);}}};var _onItemClicked = function (e) {var src = e.srcElement, uuid = src ? src.uuid : "", item = this._local.cache[uuid];if (!item) {return;}if (this.multiByCheck) {_selectCheckableItem.call(this, item);} else {_select.call(this, item, e.ctrlKey || false, e.shiftKey || false);}if (item) {this.fireEvent(new Event(CLASS.EVT_ITEMCLICKED, item, item));if (typeof this.onClicked == "function") {this.onClicked(item);}}};thi$.onItemEvent = function (e) {var type = e.getType();switch (type) {case ListItem.OP_REMOVE:this.remove(e.getItem());break;default:break;}};var _onController = function (e) {var uuid = this.controller.getAttribute("itemUUID"), item = this._local.cache[uuid], evt;switch (e.getType()) {case "click":evt = new Event("ClickController", {event:e, item:item}, this.controller);this.notifyPeer("js.swt.event.ControllerEvent", evt);break;case "mouseout":if (item && item.isHover()) {item.setHover(false);this.showController(false);}break;default:break;}};var _createController = function (def, Runtime) {var cDef = def.controller, clz, ctrl;if (cDef && cDef.classType) {ctrl = new (Class.forName(cDef.classType))(cDef, Runtime);ctrl.applyStyles({position:"absolute", display:"none"});ctrl.attachEvent("mouseout", 0, this, _onController);ctrl.attachEvent("click", 0, this, _onController);this.setController(ctrl);}};var _createContents = function () {var listView = this.listView = DOM.createElement("DIV");listView.style.cssText = "position:relative;top:0px;left:0px;border:0px none;" + "padding:0px;margin:0px;overflow:visible;" + "width:100%;height:100%;";DOM.appendTo(listView, this.view);};thi$._init = function (def, runtime) {if (typeof def !== "object") {return;}def = System.objectCopy(def, CLASS.DEFAULTDEF(), true, true);def.className = def.className || "jsvm_list";arguments.callee.__super__.apply(this, arguments);this._isReady = false;this._isLayoutDirty = false;this._canBeSearched = true;this._local.cache = {};this._selectedItems = LinkedList.$decorate([]);this._items = LinkedList.$decorate([]);this.lazy = (def.lazy === true);this.hauto = (def.hauto === true);this.vauto = (def.vauto === true);this.showTips = (def.showTips !== false);this.distinct = (def.distinct === true);this.multiEnable = (def.multiEnable === true);this.multiByCheck = (this.multiEnable && def.multiByCheck === true);_createContents.call(this);if (def.itemDefs && def.itemDefs.length > 0) {_setItemsByDef.call(this, def.itemDefs, false, true);} else {if (def.itemModels && def.itemModels.length > 0) {_setItemsByModel.call(this, def.itemModels, false, true);} else {_setAck.call(this, "ACK_ADD");}}this.setSearchEnable(def.searchEnable);_createController.call(this, def, runtime);Event.attachEvent(this.listView, "mouseover", 0, this, _onHover);Event.attachEvent(this.listView, "mouseout", 0, this, _onHover);Event.attachEvent(this.listView, "click", 0, this, _onItemClicked);J$VM.MQ.register("js.swt.event.ListItemEvent", this, this.onItemEvent);}.$override(this._init);this._init.apply(this, arguments);}.$extend(js.awt.Component);js.swt.List.EVT_READY = "Ready";js.swt.List.EVT_ACK_ITEMSADDED = "ItemsAdded";js.swt.List.EVT_ACK_ITEMSREMOVED = "ItemsRemoved";js.swt.List.EVT_ITEMSELECTED = "ItemSelected";js.swt.List.EVT_ITEMCLICKED = "ItemClicked";js.swt.List.DEFAULTDEF = function () {return {classTy:"js.swt.List", multiEnable:true, multiByCheck:false, distinct:false, lazy:false, hauto:false, vauto:false, itemModels:[], itemDefs:[], align_x:0.5, align_y:0, rigid_w:false, rigid_h:false};};js.swt.List.isIn = function (value, set) {var len = set ? set.length : 0;for (var i = 0; i < len; i++) {if (set[i] === value) {return true;}}return false;};js.swt.List.isSameModel = function (m1, m2) {if (!(m1 && m2)) {return false;}if (m1 === m2) {return true;}if ((m1.value === m2.value) && ((m1.dname === m2.dname) || (m1.img === m2.img))) {return true;}return false;};js.swt.List.isModelIn = function (model, set) {var C = js.swt.List, len = set ? set.length : 0;for (var i = 0; i < len; i++) {if (C.isSameModel(model, set[i])) {return true;}}return false;};