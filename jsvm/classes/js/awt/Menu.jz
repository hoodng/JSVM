$package("js.awt");$import("js.awt.MenuItem");js.awt.Menu = function (def, Runtime, parentMenu, rootMenu) {var CLASS = js.awt.Menu, thi$ = CLASS.prototype;if (CLASS.__defined__) {this._init.apply(this, arguments);return;}CLASS.__defined__ = true;var Class = js.lang.Class, Event = js.util.Event, DOM = J$VM.DOM, System = J$VM.System, MQ = J$VM.MQ;thi$.getPeerComponent = function () {var root = this.rootLayer();return this == root ? arguments.callee.__super__.apply(this, arguments) : root.getPeerComponent();}.$override(this.getPeerComponent);thi$.parentMenu = function () {return this._local.parent;};var _setRootMenu = function (menu) {if (menu instanceof js.awt.Menu) {this._local.root = menu;} else {if (!Class.isValid(menu)) {this._local.root = this;MQ.register("hideMenuRoot", this, _onhideMenuRoot);}}};var _setParentMenu = function (menu) {if (menu instanceof js.awt.Menu) {this._local.parent = menu;} else {if (!Class.isValid(menu)) {this._local.parent = this;}}};thi$.insertNodes = function (index, itemDefs) {var nodes = this.nodes, ibase = index, item, refNode, itemDef, clazz, i, len;if (!nodes) {nodes = this.nodes = js.util.LinkedList.$decorate([]);}item = nodes.get(index);refNode = item ? item.view : undefined;for (i = 0, len = itemDefs.length; i < len; i++) {itemDef = itemDefs[i];clazz = itemDef.classType || ("-" === itemDef.type ? "js.awt.MenuSeparator" : "js.awt.MenuItem");item = new (Class.forName(clazz))(itemDef, this.Runtime(), this);this[item.id] = item;nodes.add(ibase++, item);if (refNode) {DOM.insertAfter(item.view, refNode);} else {DOM.appendTo(item.view, this.view);}refNode = item.view;}};thi$.removeNodes = function (index, length) {var nodes = this.nodes, items = nodes.splice(index, length), item, cache = this.cache;while (items && items.length > 0) {item = items.shift();delete cache[item.uuid()];delete this[item.id];item.destroy();}};thi$.removeAllNodes = function () {var nodes = this.nodes;if (nodes) {this.removeNodes(0, nodes.length);}};thi$.canHide = function (e) {var type = e.getType();switch (type) {case "blur":return this.rootLayer().isHideOnBlur();case "mousedown":var el = e.srcElement;if (el && this.contains(el, true)) {return false;}break;}return arguments.callee.__super__.apply(this, arguments);}.$override(this.canHide);thi$.hide = function () {var item = this.active, subMenu = item ? item.subMenu() : undefined;if (item && subMenu && subMenu.isShown()) {subMenu.hide();item.setHover(false);}arguments.callee.__super__.apply(this, arguments);}.$override(this.hide);thi$.repaint = function () {if (!this._local.repaint) {var M = this.def, bounds = this.getBounds();M.width = bounds.width;M.width -= bounds.BBM ? 0 : bounds.MBP.BPW;M.height = bounds.height;M.height -= bounds.BBM ? 0 : bounds.MBP.BPH;M.z = this.getStyle("z-index");if (M.shadow === true && !this.shadowSettled()) {this.setShadowy(true);}if (M.isfloating === true && !this.floatingSettled()) {this.setFloating(true);}var nodes = this.nodes, node, i, len;for (i = 0, len = nodes.length; i < len; i++) {node = nodes[i];if (!(node instanceof js.awt.MenuSeparator)) {node.doLayout();node.setEnabled(node.isEnabled());}}this._local.repaint = true;}if (this.shadowSettled()) {this.addShadow();this.adjustShadow();}if (this.active) {this.active.setHover(false);this.active = undefined;}}.$override(this.repaint);var _notify = function (e, item) {e.setEventTarget(item);this.rootLayer().hide();this.notifyPeer("js.awt.event.MenuItemEvent", e);};var _onclick = function (e) {var el = e.srcElement, uuid = el.uuid, item = this.cache[uuid];if (item && item.isEnabled()) {if (e.getType() == "click") {if (item.hitCtrl(e)) {System.log.println("Hit the \"" + el.id + "\" ctrl.");e.setType("hitctrl");}_notify.call(this, e, item);}}};var _onMenuItem = function (e) {if (e.getType() == "input") {_notify.call(this, e, e.getEventTarget());}};var _onhideMenuRoot = function () {this.hide();};var _onmouseover = function (e) {var from = e.fromElement, to = e.toElement, fid = from ? from.uuid : undefined, tid = to ? to.uuid : undefined, fitem, titem, cache = this.cache;if (fid !== tid) {fitem = cache[fid];titem = cache[tid];if (fitem && fitem.isHover()) {var subMenu = fitem.subMenu();if (!subMenu || !subMenu.isShown()) {fitem.setHover(false);this.active = undefined;}}if (titem && !titem.isHover()) {titem.setHover(true);this.active = titem;}}};thi$.destroy = function () {this.removeAllNodes();delete this._local.root;delete this._local.parent;delete this.cache;arguments.callee.__super__.apply(this, arguments);}.$override(this.destroy);thi$._init = function (def, Runtime, parentMenu, rootMenu) {if (def == undefined) {return;}def.classType = def.classType || "js.awt.Menu";def.className = def.className || "jsvm_menu";def.isfloating = true;def.PMFlag = def.PMFlag || 39;arguments.callee.__super__.apply(this, [def, Runtime]);_setParentMenu.call(this, parentMenu);_setRootMenu.call(this, rootMenu);this.cache = {};if (def.nodes && def.nodes.length > 0) {this.insertNodes(0, def.nodes);}Event.attachEvent(this.view, "mouseover", 0, this, _onmouseover);Event.attachEvent(this.view, "mouseout", 0, this, _onmouseover);Event.attachEvent(this.view, "click", 0, this, _onclick);MQ.register("js.awt.event.ItemTextEvent", this, _onMenuItem);}.$override(this._init);this._init.apply(this, arguments);}.$extend(js.awt.Component);